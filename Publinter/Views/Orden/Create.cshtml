@model Publinter.Models.Orden_Create_Model

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Admin/bower_components/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet" />

<script src="~/Content/Admin/bower_components/moment/min/moment.min.js"></script>
<script src="~/Content/Admin/bower_components/moment/min/moment-with-locales.min.js"></script>
<script src="~/Content/Admin/bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<script src="~/Content/Utils.js"></script>

<style>
    .content-wrapper {
        display: inline-grid;
        min-height: -webkit-fill-available !important;
    }

    #mensajeExito {
        display: none;
        position: absolute;
        left: CALC(50%);
        bottom: 15px;
        padding: 10px;
        border-radius: 4px;
        color: white;
        background-color: rgb(63, 175, 82);
        width: 200px;
    }

    #mensajeErrorBack {
        display: none;
        position: absolute;
        left: CALC(50%);
        bottom: 15px;
        padding: 10px;
        border-radius: 4px;
        color: white;
        background-color: #da6262;
        width: 250px;
    }

    th {
        text-align: center;
    }

    td {
        text-align: center;
        border: 1px solid;
    }

    tr {
        height: 20px
    }

    .dato {
        width: 25px;
    }

    .noHabil {
        background-color: #ececec;
    }

    th {
        padding: 5px;
    }

    .tdBlack {
        width: 100px;
        background-color: black;
        color: white;
    }

    .txtEmisiones {
        width: 25px;
        height: 40px;
        text-align: center;
        border: none;
    }

    .div_add_linea {
        position: absolute;
        left: 6px;
        top: 48px;
    }
</style>

<script>

    $(document).ready(function () {

        $("input.txtEmisiones").keypress(function (e) {

            if (e.wich) {

            }
        });

        $("#CampaniaId").trigger("change");

        var cantLineas = $(".lineaOrden").length;
        for (var i = 0; i < cantLineas; i++) {
            var cantLineasInternas = $(".LineaInterna_" + i).length;
            for (var e = 0; e < cantLineasInternas; e++) {
                SetPrograma(i, e);
                SetMaterial(i, e);
            }
        }

        $("#Emision").val(formattedDate($("#Emision").val()));

        $("#Emision").daterangepicker({
            singleDatePicker: true,
            showDropdowns: true,
            "autoApply": true,
            "showCustomRangeLabel": false,
            locale: {
                format: 'D/M/YYYY'
            }
        });

        doc = new jsPDF();
        specialElementHandlers = {
            '#editor': function (element, renderer) {
                return true;
            }
        };
    });

    function AgregarPrimeraLinea()
    {
        var form = $("#formOrden");
        $(".btnLineas").attr("disabled","disabled")
        $.ajax({
            url: '@Url.Action("AgregarPrimeraLinea", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: form.serialize(),
            success: function (data) {
                $('#divLineas').append(data.html);

                //FiltrarProgramas();
                //FiltrarMateriales();

                SetPrograma(0,0);
                SetMaterial(0,0);
                CalcularTotalLinea(data.index);
            }
        });
    }

    function AgregarSiguienteMes()
    {
        var form = $("#formOrden");
        $(".btnLineas").attr("disabled","disabled")
        $.ajax({
            url: '@Url.Action("AgregarSiguienteMes", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: form.serialize(),
            success: function (data) {
                $('#divLineas').append(data.html);

                //FiltrarProgramas();
                //FiltrarMateriales();

                SetPrograma(data.index, 0);
                SetMaterial(data.index, 0);
                CalcularTotalLinea(data.index);
            }
        });
    }

    function CopiarUltimoMes()
    {
        var form = $("#formOrden");
        $(".btnLineas").attr("disabled","disabled")
        $.ajax({
            url: '@Url.Action("CopiarUltimoMes", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: form.serialize(),
            success: function (data) {
                $('#divLineas').append(data.html);

                //FiltrarProgramas();
                //FiltrarMateriales();

                for(e = 0; e < data.indexInterno; e++)
                {
                    SetPrograma(data.index, e);
                    SetMaterial(data.index, e);
                }     
                
                CalcularTotalLinea(data.index);
            }
        });
    }

    function AgregarLineaInterna(indexLinea)
    {
        $("#IndexLineaParaAgregar").val(indexLinea);

        var form = $("#formOrden");
        $(".btnLineas").attr("disabled","disabled")

        $.ajax({
            url: '@Url.Action("AgregarLineaInterna", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: form.serialize(),
            success: function (data) {
                $('#table_Linea_' + indexLinea + " tbody").append(data.html);

                FiltrarNuevosProgramas();
                FiltrarNuevosMateriales();

                SetPrograma(indexLinea, data.indexLineaInterna);
                SetMaterial(indexLinea, data.indexLineaInterna);
                //CalcularTotalLineaInterna(data.index); //hacer
            }
        });
    }

    function DeleteLineaInterna(index_linea, index_interna)
    {
        $("#Lineas_" + index_linea + "__LineasInternasOrden_" + index_interna + "__Deleted").val("True");

        $(".LineaInterna_" + index_linea + "_" + index_interna).hide();
        $(".LineaInterna_" + index_linea + "_" + index_interna).addClass("deleted");

        CalcularTotalOrden();
    }

    function GetOrdenesSelect()
    {
        var medioId = $("#MedioId").val();
        var campaniaId = $("#CampaniaId").val();

        $.ajax({
            url: '@Url.Action("GetOrdenesSelect", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: { campaniaId: campaniaId, medioId: medioId },
            success: function (data) {
                $("#SelectOrdenAnulaA").html(data);
                $("#SelectOrdenAnulaA").trigger('change');
            }
        });
    }

    function SetOrdenAnulaA()
    {
        var ordenAnulada = $("#SelectOrdenAnulaA").val();
        $("#OrdenAnulada").val(ordenAnulada);
    }

    function SetPrograma(index, index_interno)
    {
        var progId = $("#Programa_" + index + "_" + index_interno).val();
        $("#Lineas_" + index + "__LineasInternasOrden_" + index_interno + "__ProgramaId").val(progId);

        CalcularTotalLinea(index);
    }

    function SetMaterial(index, index_interno)
    {
        var matId = $("#Material_" + index + "_" + index_interno).val();
        $("#Lineas_" + index + "__LineasInternasOrden_" + index_interno + "__MaterialId").val(matId);

        CalcularTotalLinea(index);
    }

    function CalcularTotalLinea(index)
    {
        var totalLinea = 0;

        var bonificada = $("#Lineas_" + index + "__Bonificada").is(':checked');
        
        if(!bonificada)
        {
            for(var e = 0; e < $(".LineaInterna_" + index).length; e++)
            {
                var precio = parseFloat($("#Programa_" + index + "_" + e + " option:selected").data("precio"));
                var duracion = parseInt($("#Material_" + index + "_" + e + " option:selected").data("duracion"));
                var nroDias = $(".dia_" + index + "_" + e).length;
                var emisiones = 0;
                var deleted = $(".LineaInterna_" + index + "_" + e).hasClass("deleted");

                if (!deleted)
                {
                    for (var i = 0; i < nroDias; i++)
                    {
                        var emisionesDia = parseInt($("#Lineas_" + index + "__LineasInternasOrden_" + e + "__Mes_Dias_" + i + "__NroEmisiones").val());

                        var totalDia = emisionesDia * precio * duracion;
                        $("#Lineas_" + index + "__LineasInternasOrden_" + e + "__Mes_Dias_" + i + "__TotalDia").val(totalDia);

                        emisiones += emisionesDia;
                    }

                    var totalLineaInterna = precio * emisiones * duracion;

                    $("#Lineas_" + index + "__LineasInternasOrden_" + e + "__TotalLineaInterna").val(totalLineaInterna);

                    totalLinea += totalLineaInterna;
                }
            }
        }

        $("#totalMes_" + index).text("$ " + numberThousandSeparator(floatToStringDecimals(totalLinea, 2)));
        $("#Lineas_" + index + "__TotalLinea").val(totalLinea);

        CalcularTotalOrden();
    }

    function CalcularTotalOrden()
    {
        var cantLineas = $(".lineaOrden").length;
        var totalOrden = 0;

        for(var i = 0; i < cantLineas; i++)
        {
            totalOrden += parseFloat($("#Lineas_" + i + "__TotalLinea").val());
        }

        $("#totalOrden").text(numberThousandSeparator(floatToStringDecimals(totalOrden, 2)));
        $("#TotalOrden").val(totalOrden);
    }

    function FiltrarProgramas()
    {
        var medioId = parseInt($("#MedioId").val());

        $.ajax({
            url: '@Url.Action("GetProgramas", "Medio")',
            type: 'POST',
            dataType: 'json',
            data: { "medioId" : medioId },
            success: function (data) {
                $(".Programa").html(data.html);
            }
        });
    }

    function FiltrarNuevosProgramas()
    {
        var medioId = parseInt($("#MedioId").val());

        $.ajax({
            url: '@Url.Action("GetProgramas", "Medio")',
            type: 'POST',
            dataType: 'json',
            data: { "medioId" : medioId },
            success: function (data) {
                $(".Programa.Nuevo").html(data.html);
                $(".Programa.Nuevo").removeClass("Nuevo");
            }
        });
    }

    function FiltrarMateriales()
    {
        var campaniaId = $("#CampaniaId").val();

        $.ajax({
            url: '@Url.Action("GetMateriales", "Campania")',
            type: 'POST',
            dataType: 'json',
            data: { "campaniaId": campaniaId },
            success: function (data) {
                $(".Material").html(data.html);
            }
        });
    }

    function FiltrarNuevosMateriales()
    {
        var campaniaId = $("#CampaniaId").val();

        $.ajax({
            url: '@Url.Action("GetMateriales", "Campania")',
            type: 'POST',
            dataType: 'json',
            data: { "campaniaId": campaniaId },
            success: function (data) {
                $(".Material.Nuevo").html(data.html);
                $(".Material.Nuevo").removeClass("Nuevo");
            }
        });
    }

    function openMensajeExito()
    {
        $("#mensajeExito").fadeIn();
        setTimeout(function () { $("#mensajeExito").fadeOut(); $("#errorMsgDiv").fadeOut(); }, 10000)
    }

    function openMensajeErrorBack()
    {
        $("#mensajeErrorBack").fadeIn();
        setTimeout(function () { $("#mensajeErrorBack").fadeOut(); $("#errorMsgDivBack").fadeOut(); }, 10000)
    }

    function ShowMsgErrorComp()
    {
        $("#errorMsgDiv").slideDown();
    }

    function closeMessage()
    {
        $("#mensajeExito").fadeOut();
        $("#mensajeError").fadeOut();
        $("#errorMsgDiv").fadeOut();
    }

    function LimpiarDatos()
    {
        ReiniciarLineas();
        AddNumero();
        $("#SelectOrdenAnulaA").val("0");
    }

    function ReiniciarLineas()
    {
        $("#divLineas").html("");
        AgregarPrimeraLinea();
    }

    function AddNumero()
    {
        $("#NroOrden").val(parseInt($("#NroOrden").val()) + 1);
        $("h3.title").text("Órden Nro. " + $("#NroOrden").val());
    }

    function GuardarOrden()
    {
        var form = $("#formOrden");
        $("#btnGuardar").attr("disabled", "disabled");
        $.ajax({
            url: '@Url.Action("Create", "Orden")',
            type: 'POST',
            dataType: 'json',
            data: form.serialize(),
            success: function (data) {
                if(data)
                {
                    LimpiarDatos();
                    //$("#txtMensajeExito").text(data.descripcion);
                    $("#txtMensajeExito").attr("href", "IndexDetalle");
                    $("#btnExportPdf").removeAttr("disabled");
                    openMensajeExito();
                }
                else
                {
                    $("#msgErrorBack").text(data.errorMsg);
                    openMensajeErrorBack();
                }
                $("#btnGuardar").removeAttr("disabled");
            }
        });
    }

    function SetBonificada(index)
    {
        var value = $("#Lineas_" + index + "__Bonificada").is(':checked');

        if(value)
            $(".dias_" + index).css("background-color", "#daffda");
        else
            $(".dias_" + index).css("background-color", "white");

        CalcularTotalLinea(index);
    }


    //funcion para exportar el form a pdf.
    function ExportPdf(val)
    {
        $("#GuardarEnviarDescargar").val(val);
        $("#formOrden").submit();
    }

</script>

<div class=" register-box-body col-sm-12">

    @using (Html.BeginForm("Create", "Orden", FormMethod.Post, new { @id = "formOrden" }))
    {

        <div id="wrap_orden">
            <div id="divEncabezado">
                @Html.Partial("~/Views/Orden/CreateEncabezado.cshtml", Model)
            </div>
            <div id="divLineas">
                @Html.Partial("~/Views/Orden/CreateLineas.cshtml", Model)
            </div>
            <div id="divFooter">
                @Html.Partial("~/Views/Orden/CreateFooter.cshtml", Model)
            </div>
        </div>

        @Html.HiddenFor(x => x.GuardarEnviarDescargar)
    }

</div>

<div id="mensajeExito">
    <div style="opacity: 1; margin-top: 0px;">
        <div>
            <a href="#" class="pull-right" onclick="closeMessage()" style="color:white"><i class="fa fa-close" aria-hidden="true"></i></a>
            <a id="txtMensajeExito" target="_blank" href="" style="font-weight:bold;color:white"></a> generada correctamente.
        </div>
    </div>
</div>

<div id="mensajeErrorBack">
    <div style="opacity: 1; margin-top: 0px;">
        <div>
            <a href="#" class="pull-right" onclick="closeMessage()" style="color:white"><i class="fa fa-close" aria-hidden="true"></i></a>
            <span id="spanErrorCompBack">Hubo un error al generar la órden.</span>
            <div>
                <a id="errorMsgVerDetalle" href="javascript:ShowMsgErrorComp()" style="color:white;font-size:12px">Ver detalle</a>
                <div id="errorMsgDiv" style="display:none">
                    <span id="msgError"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/Utils.js"></script>
<script src="~/Content/JS/jsPdf/jspdf.min.js"></script>
<script src="~/Content/JS/jsPdf/jspdf-autotable.js"></script>
<script src="~/Scripts/html2canvas.js"></script>


